import fs from"fs";import glob from"glob";import postcss from"postcss";import selectorParser from"postcss-selector-parser";function normalizeArray(t,e){for(var r=0,o=t.length-1;o>=0;o--){var n=t[o];"."===n?t.splice(o,1):".."===n?(t.splice(o,1),r++):r&&(t.splice(o,1),r--)}if(e)for(;r--;r)t.unshift("..");return t}var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,splitPath=function(t){return splitPathRe.exec(t).slice(1)};function resolve(){for(var t="",e=!1,r=arguments.length-1;r>=-1&&!e;r--){var o=r>=0?arguments[r]:"/";if("string"!=typeof o)throw new TypeError("Arguments to path.resolve must be strings");o&&(t=o+"/"+t,e="/"===o.charAt(0))}return t=normalizeArray(filter(t.split("/"),function(t){return!!t}),!e).join("/"),(e?"/":"")+t||"."}function normalize(t){var e=isAbsolute(t),r="/"===substr(t,-1);return(t=normalizeArray(filter(t.split("/"),function(t){return!!t}),!e).join("/"))||e||(t="."),t&&r&&(t+="/"),(e?"/":"")+t}function isAbsolute(t){return"/"===t.charAt(0)}function join(){return normalize(filter(Array.prototype.slice.call(arguments,0),function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))}function relative(t,e){function r(t){for(var e=0;e<t.length&&""===t[e];e++);for(var r=t.length-1;r>=0&&""===t[r];r--);return e>r?[]:t.slice(e,r-e+1)}t=resolve(t).substr(1),e=resolve(e).substr(1);for(var o=r(t.split("/")),n=r(e.split("/")),i=Math.min(o.length,n.length),a=i,s=0;s<i;s++)if(o[s]!==n[s]){a=s;break}var l=[];for(s=a;s<o.length;s++)l.push("..");return(l=l.concat(n.slice(a))).join("/")}var sep="/",delimiter=":";function dirname(t){var e=splitPath(t),r=e[0],o=e[1];return r||o?(o&&(o=o.substr(0,o.length-1)),r+o):"."}function basename(t,e){var r=splitPath(t)[2];return e&&r.substr(-1*e.length)===e&&(r=r.substr(0,r.length-e.length)),r}function extname(t){return splitPath(t)[3]}var path={extname:extname,basename:basename,dirname:dirname,sep:sep,delimiter:delimiter,relative:relative,join:join,isAbsolute:isAbsolute,normalize:normalize,resolve:resolve};function filter(t,e){if(t.filter)return t.filter(e);for(var r=[],o=0;o<t.length;o++)e(t[o],o,t)&&r.push(t[o]);return r}var substr="b"==="ab".substr(-1)?function(t,e,r){return t.substr(e,r)}:function(t,e,r){return e<0&&(e=t.length+e),t.substr(e,r)},defaultOptions={css:[],content:[],extractors:[],whitelist:[],output:void 0,stdout:!1,info:!1,rejected:!1,legacy:!1,keyframes:!1},IGNORE_ANNOTATION="purgecss ignore",CONFIG_FILENAME="purgecss.config.js",ERROR_CONFIG_FILE_LOADING="Error loading the config file",ERROR_MISSING_CONTENT="No content provided.",ERROR_MISSING_CSS="No css provided.",ERROR_EXTRACTER_FAILED="The extractor has failed to extract the selectors.",ERROR_OPTIONS_TYPE="Error Type Options: expected an object",ERROR_OUTPUT_TYPE="Error Type option output: expected a string",ERROR_EXTRACTERS_TYPE="Error Type option extractors: expected an array",ERROR_WHITELIST_TYPE="Error Type option whitelist: expected an array",ERROR_WHITELIST_PATTERNS_TYPE="Error Type option whitelistPatterns: expected an array",ERROR_STDOUT_TYPE="Error Type option stdout: expected a boolean",ERROR_INFO_TYPE="Error Type option info: expected a boolean",ERROR_REJECTED_TYPE="Error Type option rejected: expected a boolean",CSS_WHITELIST=["*","::-webkit-scrollbar","::selection",":root","::before","::after"],SELECTOR_STANDARD_TYPES=["class","id","universal","pseudo"],_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),e}}(),toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)},DefaultExtractor=function(){function t(){classCallCheck(this,t)}return createClass(t,null,[{key:"extract",value:function(t){return t.match(/[A-Za-z0-9_-]+/g)}}]),t}(),LegacyExtractor=function(){function t(){classCallCheck(this,t)}return createClass(t,null,[{key:"extract",value:function(t){return t.split(/[^a-z]/g)}}]),t}(),Purgecss=function(){function t(e){classCallCheck(this,t),this.atRules={keyframes:{}},"string"!=typeof e&&void 0!==e||(e=this.loadConfigFile(e)),this.checkOptions(e),this.options=Object.assign(defaultOptions,e)}return createClass(t,[{key:"loadConfigFile",value:function(t){var e=void 0===t?CONFIG_FILENAME:t,r=void 0;try{var o=path.resolve(process.cwd(),e);r=require(o)}catch(t){throw new Error(ERROR_CONFIG_FILE_LOADING+t.message)}return r}},{key:"checkOptions",value:function(t){if("object"!==(void 0===t?"undefined":_typeof(t)))throw new TypeError(ERROR_OPTIONS_TYPE);if(!t.content||!t.content.length)throw new Error(ERROR_MISSING_CONTENT);if(!t.css||!t.css.length)throw new Error(ERROR_MISSING_CSS);if(t.output&&"string"!=typeof t.output)throw new TypeError(ERROR_OUTPUT_TYPE);if(t.extractors&&!Array.isArray(t.extractors))throw new TypeError(ERROR_EXTRACTERS_TYPE);if(t.whitelist&&!Array.isArray(t.whitelist))throw new TypeError(ERROR_WHITELIST_TYPE);if(t.stdout&&"boolean"!=typeof t.stdout)throw new TypeError(ERROR_STDOUT_TYPE);if(t.info&&"boolean"!=typeof t.info)throw new TypeError(ERROR_INFO_TYPE);if(t.rejected&&"boolean"!=typeof t.rejected)throw new TypeError(ERROR_REJECTED_TYPE);if(t.whitelistPatterns&&!Array.isArray(t.whitelistPatterns))throw new TypeError(ERROR_WHITELIST_PATTERNS_TYPE)}},{key:"purge",value:function(){var t=this.options,e=t.content,r=t.extractors,o=t.css,n=e.filter(function(t){return"string"==typeof t}),i=e.filter(function(t){return"object"===(void 0===t?"undefined":_typeof(t))}),a=this.extractFileSelector(n,r),s=this.extractRawSelector(i,r);return this.getCssContents(o,new Set([].concat(toConsumableArray(a),toConsumableArray(s))))}},{key:"getCssContents",value:function(t,e){var r=[],o=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(o=(a=s.next()).done);o=!0){var l=a.value,u=null,c="";"string"==typeof l?(u=l,c=this.options.stdin?u:fs.readFileSync(u,"utf8")):c=l.raw,this.root=postcss.parse(c),this.getSelectorsCss(e),this.options.keyframes&&this.removeUnusedKeyframes(),r.push({file:u,css:this.root.toString()})}}catch(t){n=!0,i=t}finally{try{!o&&s.return&&s.return()}finally{if(n)throw i}}return r}},{key:"removeUnusedKeyframes",value:function(){var t=new Set;this.root.walkDecls(/animation/,function(e){var r=!0,o=!1,n=void 0;try{for(var i,a=e.value.split(" ")[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var s=i.value;t.add(s)}}catch(t){o=!0,n=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw n}}});for(var e in this.atRules.keyframes){t.has(e)||this.atRules.keyframes[e].remove()}}},{key:"extractRawSelector",value:function(t,e){var r=new Set,o=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(o=(a=s.next()).done);o=!0){var l=a.value,u=l.raw,c=l.extension,f=this.getFileExtractor("."+c,e);r=new Set([].concat(toConsumableArray(r),toConsumableArray(this.extractSelectors(u,f))))}}catch(t){n=!0,i=t}finally{try{!o&&s.return&&s.return()}finally{if(n)throw i}}return r}},{key:"extractFileSelector",value:function(t,e){var r=new Set,o=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(o=(a=s.next()).done);o=!0){var l=a.value,u=[];fs.existsSync(l)?u.push(l):u=glob.sync(l);var c=!0,f=!1,y=void 0;try{for(var p,h=u[Symbol.iterator]();!(c=(p=h.next()).done);c=!0){var v=p.value,E=fs.readFileSync(v,"utf8"),R=this.getFileExtractor(v,e);r=new Set([].concat(toConsumableArray(r),toConsumableArray(this.extractSelectors(E,R))))}}catch(t){f=!0,y=t}finally{try{!c&&h.return&&h.return()}finally{if(f)throw y}}}}catch(t){n=!0,i=t}finally{try{!o&&s.return&&s.return()}finally{if(n)throw i}}return r}},{key:"getFileExtractor",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.length?e.find(function(e){return e.extensions.find(function(e){return t.endsWith(e)})}).extractor:!0===this.options.legacy?LegacyExtractor:DefaultExtractor}},{key:"extractSelectors",value:function(t,e){var r=new Set,o=e.extract(t);if(null===o)throw new Error(ERROR_EXTRACTER_FAILED);return o.forEach(function(t){r.add(t)}),r.delete(""),r}},{key:"getSelectorsCss",value:function(t){var e=this;this.root.walkRules(function(r){var o=r.prev();if(!e.isIgnoreAnnotation(o)){r.selector=selectorParser(function(r){r.walk(function(r){var o=[];if("selector"===r.type){if(r.parent&&":not"===r.parent.value&&"pseudo"===r.parent.type)return;var n=!0,i=!1,a=void 0;try{for(var s,l=r.nodes[Symbol.iterator]();!(n=(s=l.next()).done);n=!0){var u=s.value,c=u.type,f=u.value;SELECTOR_STANDARD_TYPES.includes(c)&&void 0!==f?o.push(f):"tag"!==c||/[+]|(even)|(odd)|^from$|^to$|^\d/.test(f)||o.push(f)}}catch(t){i=!0,a=t}finally{try{!n&&l.return&&l.return()}finally{if(i)throw a}}e.shouldKeepSelector(t,o)||r.remove()}})}).processSync(r.selector);var n=r.parent;"atrule"===n.type&&e.options.keyframes&&"keyframes"===n.name&&(e.atRules.keyframes[n.params]=n),r.selector||r.remove(),e.isRuleEmpty(n)&&n.remove()}})}},{key:"isIgnoreAnnotation",value:function(t){return!(!t||"comment"!==t.type)&&t.text.includes(IGNORE_ANNOTATION)}},{key:"isRuleEmpty",value:function(t){return!!("decl"===t.type&&!t.value||"rule"===t.type&&!t.selector||t.nodes&&!t.nodes.length||"atrule"===t.type&&(!t.nodes&&!t.params||!t.params&&!t.nodes.length))}},{key:"shouldKeepSelector",value:function(t,e){var r=!0,o=!1,n=void 0;try{for(var i,a=e[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var s=i.value;if(this.options.legacy){var l=s.split(/[^a-z]/g),u=!1,c=!0,f=!1,y=void 0;try{for(var p,h=l[Symbol.iterator]();!(c=(p=h.next()).done);c=!0){var v=p.value;if(v){if(!t.has(v))break;u=!0}}}catch(t){f=!0,y=t}finally{try{!c&&h.return&&h.return()}finally{if(f)throw y}}if(u)return!0;if(t.has(s)||CSS_WHITELIST.includes(s)||this.isSelectorWhitelisted(s))return!0}else{var E=s.replace(/\\/g,"");if(E.startsWith(":"))continue;if(!(t.has(E)||CSS_WHITELIST.includes(E)||this.isSelectorWhitelisted(E)))return!1}}}catch(t){o=!0,n=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw n}}return!this.options.legacy}},{key:"isSelectorWhitelisted",value:function(t){return!!(CSS_WHITELIST.includes(t)||this.options.whitelist&&this.options.whitelist.some(function(e){return e===t})||this.options.whitelistPatterns&&this.options.whitelistPatterns.some(function(e){return e.test(t)}))}}]),t}();export default Purgecss;
